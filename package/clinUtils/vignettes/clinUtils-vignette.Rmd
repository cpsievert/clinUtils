---
title: "Vignette of the `clinUtils` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
vignette: >
  %\VignetteIndexEntry{Introduction to the `clinUtils` package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r optionsChunks, echo = FALSE, cache = FALSE}

	library(knitr)

	knitr::opts_chunk$set(
		message = FALSE,
		# stop document execution if error (not the default)
		error = FALSE, # stop-on-error
		fig.align = "center",
		fig.path = "./figures_vignette/",
		echo = TRUE
	)
	
```

This package `clinUtils` compiles functionalities
for analysis of clinical datasets in R [@R].

```{r loadPackages}

	library(clinUtils)
	library(pander)

```

# Data pre-processing

## Data import

The [`haven`](https://cran.r-project.org/package=haven) R package enables to load 
SAS datasets in `sas7bdat` and `xpt` formats.

The function `loadDataADaMSDTM` imports multiple
SAS datasets at once. This returns a list of dataset (once by domain).
The variable labels are combined across datasets and available in
a dedicated attribute.

```{r loadData}

	pathExampleDatasets <- list.files(
		path = system.file("extdata", "cdiscpilot01", package = "clinUtils"), 
		pattern = "*.xpt", 
		full.names = TRUE
	)
	
	data <- loadDataADaMSDTM(files = pathExampleDatasets)
	# A list is returned, each separated file is accessible via data$[fileName]
	pander(head(data$DM))
	pander(head(data$LB))
	pander(head(data$AE))
	
	# Access labels for all variables
	labelVars <- attr(data, "labelVars")
	labelVars
	# Access label for particular variable: 
	labelVars["USUBJID"]

```

## Example datasets

To demonstrate the functionalities of this package, 
a subset of the _SDTM_ datasets from the CDISC Pilot 01 
study, imported into R are available in the package as well.

```{r loadADaMSDTMDatasets}
	
	## ADaM
	
	# load data
	data(dataADaMCDISCP01)
	dataADaM <- dataADaMCDISCP01
	names(dataADaM)
	pander(head(dataADaM$ADSL))
	pander(head(dataADaM$ADLBC))
	pander(head(dataADaM$ADAE))
	labelVarsADaM <- attr(dataADaM, "labelVars")

	## SDTM

	# load data
	data(dataSDTMCDISCP01)
	dataSDTM <- dataSDTMCDISCP01
	names(dataSDTM)
	pander(head(dataSDTM$DM))
	pander(head(dataSDTM$LB))
	pander(head(dataSDTM$AE))
	labelVarsSDTM <- attr(dataSDTM, "labelVars")

```

## Variable labels

Note: By default, when the data is loaded with the `loadDataADaMSDTM` (via the `haven` package),  the labels for each variable are available in an attribute of each column.  
However, this attribute is lost when the dataset is subsetted as a data.frame.

The function `getLabelVar` extracts the label for the specified variables.

```{r getLabelVar}

	# upon reading the data: attributes are available in each column
	getLabelVar(data = dataADaM$ADAE, var = "AEDECOD")
	
	# Please note that when the data is converted to data.frame
	# if the data is subsetted, the label is lost:
	getLabelVar(data = subset(dataADaM$ADAE, AESEV == "MODERATE"), var = "AEDECOD")

	# so always use 'labelVars':
	getLabelVar(var = "AEDECOD", labelVars = labelVars)
	
```

## Get parameter label from its parameter code

The function `getLabelParamcd` get the label from specific parameter(s) code.

```{r getLabelParamcd}

	getLabelParamcd(paramcd = "CHOL", data = dataADaM$ADLB)

```

# Visualizations

## Palette for CDISC variables

Palette for typical CDISC-variable(s) are available in the package.

### Normal reference range indicators

Meaningful colors and symbols for a Normal Reference Range Indicator
CDISC variable (`-NRIND`) are extracted via the `colorPaletteNRIND`
and `shapePaletteNRIND` respectively:

```{r palette-show}
print(colorPaletteNRIND)
print(shapePaletteNRIND)
```

```{r palette-plot, fig.height = 8}
plot(
	x = seq_along(colorPaletteNRIND),
	col = colorPaletteNRIND, 
	bg = colorPaletteNRIND, 
	pch = shapePaletteNRIND
)
text(
	x = seq_along(colorPaletteNRIND),
	labels = names(colorPaletteNRIND), pos = 3
)
title("Palette for CDISC normal reference range indicator")
```
The `getPaletteCDISC` function extracts such palette for a specified
variable.  

This retains only the categories available in the variable,
and ensures that extra symbols are extracted in case non standard
categories are available in the data.

```{r getPaletteCDISC}
dataPlot <- subset(dataSDTM$LB, LBTEST == "Cholesterol")

colorPalette <- getPaletteCDISC(x = dataPlot$LBNRIND, var = "NRIND", type = "color")
print(colorPalette)
shapePalette <- getPaletteCDISC(x = dataPlot$LBNRIND, var = "NRIND", type = "shape")
print(shapePalette)

# visualize profile over time
gg <- ggplot(data = dataPlot) +
	geom_point(aes(x = LBDY, y = LBSTRESN, 
		color = LBNRIND, fill = LBNRIND, shape = LBNRIND)) +
	ggtitle("Evolution of Neutrophils actual value over time")
print(gg)

# use 'standard' symbols/colors
# ('limits' is only required if the categories are not already ordered in LBNRIND)
gg + 
	scale_color_manual(values = colorPalette, limits = names(colorPalette)) +
	scale_fill_manual(values = colorPalette, limits = names(colorPalette)) +
	scale_shape_manual(values = shapePalette, limits = names(colorPalette))
```

# Reporting tools

### Utility function for interactive table

The [DT](https://cran.r-project.org/package=DT) package enables to create
interactive table in HTML format.
Such interactivity includes the possibilities to wrap long tables,
filter columns.

The `toDTGLPG` function is an utility function containing sensitive default settings
and extra common
functionalities to include in this table, e.g. possibility to expand
a row variable, to include bar visualization, ...

```{r toDTGLPG}

	dataTEAE <- subset(dataADaM$ADAE, SAFFL == "Y" & TRTEMFL == "Y")
	
	# set column names to labels
	labelVarsTEAE <- getLabelVar(
		var = colnames(dataTEAE), 
		labelVars = labelVarsADaM
	)
	colnamesTEAE <- setNames(names(labelVarsTEAE), labelVarsTEAE)
	
	# add patient profiles link (if available)
	dataTEAE <- createPatientProfileVar(
		data = dataTEAE, 
		patientProfilePath = "patientProfiles", 
		checkExist = FALSE
	)
	dataTEAE <- dataTEAE[order(dataTEAE$AESOC), ]
	
	toDTGLPG(
		dataTEAE, 
		colnames = colnamesTEAE, 
		rowGroupVar = c("AESOC"),
		expandVar = c("patientProfileLink"),
		nonVisibleVar = c("patientProfilePath"),
		# patient profile URL should be considered as raw HTML
		escape = -grep("patientProfileLink", colnames(dataTEAE)),
		barVar = "AGE",
		barRange = c(0, 100),
		caption = "Listing of treatment-emergent adverse events on the safety analysis set"
	)

```

## Include list of objects in a _Rmarkdown_ document

In [knitr](https://CRAN.R-project.org/package=knitr), some chunk options are not available/vectorized
for each object printed within a chunk.
The functions `knitPrintListPlots` and `knitPrintListObjects` include each
plot/object contained in a list in a separated code chunk, in which different chunk 
options can be specified.

Please note that the following chunk option should be used: **`results = 'asis'`**.

### Static figures with `ggplot2`

For example, the options to specify figure dimensions should be the same for all plots
generated from the same chunk (`fig.height`/`fig.width`).

```{r knitPrintListPlots-static, out.width = "100%", warning = FALSE, results = "asis"}
	
	library(plyr)
	
	dataADLB <- dataADaMCDISCP01$ADLB
	
	# create plots:
	listPlotsLB <- dlply(dataADLB, "PARCAT1", function(data)
		ggplot(data = data) +
			geom_histogram(aes(fill = ANRIND, x = TRTA), stat = "count", position = "dodge") +
			facet_wrap(~ PARAMCD) +
			theme(axis.text.x = element_text(angle = -45, hjust = 0))
	)
	# n2mfrow: extract default dimensions for a specified number of plots
	figDim <- dlply(dataADLB, "PARCAT1", function(data) 
		n2mfrow(length(unique(data$PARAMCD)))
	)
	knitPrintListPlots(
		plotsList = listPlotsLB, 
		generalLabel = "lab-hist-static",
		type = "ggplot2",
		# set caption for each figure
		fig.cap = paste("Barplot of", tolower(names(listPlotsLB)), "measurements"),
		# specify different dimensions
		fig.width = sapply(figDim, "[[", 1) * 2 + 1, # 3 in for each plot + 1 in for the legend
		fig.height = sapply(figDim, "[[", 2) * 2 + 2, # 3 in for each plot + 2 for x-axis labels
		# include title before each visualization
		titles = simpleCap(tolower(names(listPlotsLB))),
		titleLevel = 4
	)

```

### Interactive figures with `plotly`

#### Include visualizations in document

A list of interactive figures can be included within a _Rmarkdown_
document with the `htmltools::tagList` function.
The function `knitPrintListPlots` with the `type`
set to 'plotly' enables to include additionally e.g. a caption or a title.

```{r knitPrintListPlots-interactive, warning = FALSE, results = "asis"}
	
library(plotly)
listPlotsLB <- dlply(dataADLB, "PARCAT1", function(dataParcat){
	plot_ly(data = dataParcat, x = ~ TRTA, type = "histogram",
		color = ~ ANRIND, 
		legendgroup = "color"
	)
})
knitPrintListPlots(
	plotsList = listPlotsLB, 
	generalLabel = "lab-hist-interactive",
	type = "plotly",
	# set caption for each figure
	fig.cap = paste("Barplot of", tolower(names(listPlotsLB)), "measurements"),
	# include title before each visualization
	titles = simpleCap(tolower(names(listPlotsLB))),
	titleLevel = 5
)

```

### List of flextable objects

**List of [`flextable`](https://CRAN.R-project.org/package=flextable ) objects** cannot be included 
from the same chunk of a _Rmarkdown_ document.
The function `knitPrintListObjects` is used to included each `flextable` object in a 
separated chunk.
Please note that the following chunk option should be used: **`results = 'asis'`**.

```{r knitPrintListObjects-flextable, warning = FALSE, results = "asis"}
	
	listFtLB <- dlply(dataADLB, "PARCAT1", function(dataParcat){
		flextable(data = head(dataParcat))
	})
	
	knitPrintListObjects(
		xList = listFtLB, 
		generalLabel = "lab-hist-ft",
		titles = simpleCap(tolower(names(listFtLB))),
		titleLevel = 4
	)

```

### `htmltools::tagList` solution

Please note that the `tagList` function of the `htmltools` package can also be used
to include plots with associated title.
However, in this case the titles are not automatically numbered by `knitr`.

```{r knitPrintListObjects-tagList, warning = FALSE, results = "asis"}
	
	library(htmltools)
	tagListArgs <- unlist(
		lapply(names(listPlotsLB), function(name) list(h4(name), listPlotsLB[[name]]))
	, recursive = FALSE)
	do.call(htmltools::tagList, tagListArgs)

```

# Appendix

## Session information

```{r includeSessionInfo, echo = FALSE}

	library(pander)
	pander(sessionInfo())

```
